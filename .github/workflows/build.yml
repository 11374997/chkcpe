name: Run CPE validations on FreeBSD Portstree
on:
  push:
    paths-ignore:
      - '**.md'
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  CPE_DICTIONARY: https://nvd.nist.gov/feeds/xml/cpe/dictionary/official-cpe-dictionary_v2.3.xml.gz

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository code
        uses: actions/checkout@v2

      - name: Check out FreeBSD Portstree
        uses: actions/checkout@v2
        with:
          repository: freebsd/freebsd-ports
          path: ports

      - name: Fetch NVD CPE Dictionary
        run: wget -qO - ${{ env.CPE_DICTIONARY }} | gunzip -c > data/cpe.xml

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.0'
          tools: composer

      - name: Install bmake
        run: |
          sudo apt-get update
          sudo apt-get install bmake

      - name: Install parallel
        run: |
          sudo apt-get install parallel

      - name: Install Composer dependencies
        run: |
          composer install

      - name: Prepare directories
        run: mkdir logs

      - name: Build sqlite CPE DB from XML
        env:
          CPEDB: sqlite:logs/cpe.sqlite
        run: |
          sqlite3 logs/cpe.sqlite < data/schema.sql
          ./bin/cpe2sqlite data/cpe.xml

      - name: Run chkcpe
        env:
          MAKESYSPATH: .../share/mk:/home/runner/work/chkcpe/chkcpe/share/mk:/usr/share/mk
          PORTSDIR: ports
          DATADIR: data
          LOGSDIR: logs
          CPEDB: sqlite:logs/cpe.sqlite
          MAKE: /usr/bin/bmake
          ARCH: amd64
          OPSYS: FreeBSD
          OSREL: 13.0
          OSVERSION: 1300139
          _OSRELEASE: 13.0-RELEASE
          MAKE_JOBS_NUMBER: 1
          CONFIGURE_MAX_CMD_LEN: 524288
        run: |
          ./bin/chkcpe

      - name: Upload logfiles
        uses: actions/upload-artifact@v2
        with:
          name: cpe-logs
          path: logs

      - name: Check out repository wiki
        uses: actions/checkout@v2
        with:
          repository: ${{ github.repository }}.wiki
          path: wiki

      - name: Upload reports to wiki
        run: |
          cp -p logs/env logs/*.md wiki/
          cd wiki
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git diff-index --quiet HEAD || git commit -m "Add changes" && git push
