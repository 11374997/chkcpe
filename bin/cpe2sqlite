#!/usr/bin/env php
<?php
declare(strict_types=1);

require __DIR__ . '/../vendor/autoload.php';

use CheckCpe\Config;
use CheckCpe\Util\Logger;
use CheckCpe\CPE\Dictionary;
use CheckCpe\CPE\Product;

Logger::start();

if($argc != 2)
   die("Usage: cpe2sqlite cpe-dictionary.xml\n");

$xml = simplexml_load_file($argv[1]);

$db = Config::getDbHandle();
$db->exec('DELETE FROM cpes');
$db->exec('DELETE FROM products');
$db->exec('VACUUM;');
$db->exec('BEGIN TRANSACTION;');

$dictionary = new Dictionary($db);

$cnt = 0;

foreach ($xml->{'cpe-item'} as $cpe)
{
   /*
    <cpe-item name="cpe:/a:xiph:libvorbis:1.3.6" deprecated="true" deprecation_date="2019-10-17T15:10:18.580Z">
      <title xml:lang="en-US">Xiph Libvorbis 1.3.6</title>
      <references>
        <reference href="https://xiph.org/downloads/">Product</reference>
      </references>
      <cpe-23:cpe23-item name="cpe:2.3:a:xiph:libvorbis:1.3.6:*:*:*:*:*:*:*">
        <cpe-23:deprecation date="2019-10-17T11:10:18.580-04:00">
          <cpe-23:deprecated-by name="cpe:2.3:a:xiph.org:libvorbis:1.3.6:*:*:*:*:*:*:*" type="NAME_CORRECTION"/>
        </cpe-23:deprecation>
      </cpe-23:cpe23-item>
    </cpe-item>
   */

   try
   {
      $cpe_title = $cpe->title;
      $cpe_deprecated = $cpe->attributes(null)->deprecated;
      $cpe_fs = (string)$cpe->children('cpe-23', TRUE)->{'cpe23-item'}->attributes(null)->name;

      $product = new Product($cpe_fs);

      if($cpe_deprecated == 'true'){
         $cpe_deprecated_by = (string)$cpe->children('cpe-23', TRUE)->{'cpe23-item'}->{'deprecation'}->{'deprecated-by'}->attributes(null)->name;

         $product->setDeprecatedBy(new Product($cpe_deprecated_by));
      }

      if(!$dictionary->addProduct($product)) {
         Logger::error('Could not add Product '.$cpe_fs);
         continue;
      }
   }
   catch(\Exception $e)
   {
      Logger::error($e->getMessage());
   }

   if (++$cnt % 10000 == 0) {
      Logger::info('Added '.$cnt.' CPE entries');
      $db->exec('COMMIT;');
      $db->exec('BEGIN TRANSACTION;');
   }
}

$db->exec('COMMIT;');
